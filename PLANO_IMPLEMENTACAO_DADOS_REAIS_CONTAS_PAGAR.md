# üìã Plano de Implementa√ß√£o - Dados Reais em Contas a Pagar

## üéØ Objetivo
Remover todos os dados mock e implementar integra√ß√£o completa com banco de dados real (Supabase) no m√≥dulo de Contas a Pagar.

---

## üìä An√°lise da Situa√ß√£o Atual

### ‚úÖ O que est√° funcionando:
- ‚úÖ Estrutura de p√°ginas (List, Form, Details) completa
- ‚úÖ Valida√ß√µes de formul√°rio implementadas
- ‚úÖ Upload de anexos funcionando
- ‚úÖ Rotas configuradas
- ‚úÖ Sidebar integrado
- ‚úÖ Tipos TypeScript definidos corretamente

### ‚ùå O que precisa ser corrigido:
- ‚ùå **Listagem usando dados MOCK** ao inv√©s de buscar do banco
- ‚ùå **company_id n√£o √© preenchido** ao criar registros
- ‚ùå **Inconsist√™ncia de nomes de campos** entre migrations
- ‚ùå **Inconsist√™ncia de valores de status** (enum vs string)
- ‚ùå **Estat√≠sticas calculadas sobre mocks** ao inv√©s de dados reais
- ‚ùå **Tratamento de erros limitado**

---

## üîç Verifica√ß√µes Necess√°rias

### 1. Estrutura Real do Banco de Dados
**Task:** Criar script para verificar estrutura real da tabela `contas_pagar` no Supabase
- Verificar quais campos existem (portugu√™s vs ingl√™s)
- Verificar se enum `status_conta_pagar` existe
- Verificar se campos obrigat√≥rios est√£o presentes
- Verificar se √≠ndices foram criados

### 2. Fun√ß√£o para Obter Company ID
**Status:** ‚úÖ J√° existe fun√ß√£o `getOrCreateDefaultCompany()` em `company-utils.ts`
**Uso:** J√° usada em outras p√°ginas (ObrasList, ColaboradoresList)

---

## üóÇÔ∏è Estrutura de Implementa√ß√£o

### Fase 1: Verifica√ß√£o e Diagn√≥stico
1. Criar script de verifica√ß√£o da estrutura do banco
2. Executar script e analisar resultados
3. Documentar estrutura real encontrada
4. Identificar inconsist√™ncias

### Fase 2: Corre√ß√£o de Estrutura (se necess√°rio)
1. Verificar qual migration foi realmente aplicada
2. Criar migration de corre√ß√£o (se necess√°rio)
3. Ajustar tipos TypeScript se houver diferen√ßas
4. Atualizar c√≥digo para usar campos corretos

### Fase 3: Implementa√ß√£o de Service/API
1. Criar arquivo `contas-pagar-api.ts` com fun√ß√µes:
   - `getContasPagar(companyId, filters?)` - Buscar contas
   - `getContaPagarById(id)` - Buscar uma conta
   - `createContaPagar(data, companyId)` - Criar conta
   - `updateContaPagar(id, data)` - Atualizar conta
   - `deleteContaPagar(id)` - Deletar conta
   - `getEstatisticas(companyId)` - Buscar estat√≠sticas
2. Implementar tratamento de erros robusto
3. Implementar loading states

### Fase 4: Integra√ß√£o nas P√°ginas
1. **ContasPagarList.tsx:**
   - Remover imports de mocks
   - Implementar busca real com `getContasPagar()`
   - Implementar c√°lculo de estat√≠sticas reais
   - Adicionar tratamento de erros
   - Adicionar loading states

2. **ContaPagarForm.tsx:**
   - Garantir que `company_id` seja preenchido ao criar
   - Usar `getOrCreateDefaultCompany()` para obter company_id
   - Preencher `created_by` e `updated_by` com user.id
   - Melhorar tratamento de erros

3. **ContaPagarDetails.tsx:**
   - J√° est√° buscando dados reais (verificar se est√° completo)
   - Melhorar tratamento de erros

### Fase 5: Ajustes de Status
1. Verificar como o banco armazena status (enum vs string)
2. Criar fun√ß√£o de mapeamento entre valores se necess√°rio
3. Ajustar c√≥digo para usar valores corretos
4. Corrigir trigger do banco se necess√°rio

### Fase 6: Testes e Valida√ß√£o
1. Testar cria√ß√£o de conta
2. Testar listagem
3. Testar filtros e busca
4. Testar edi√ß√£o
5. Testar exclus√£o
6. Testar upload de anexo
7. Validar estat√≠sticas

---

## üìù Detalhamento das Tasks

### TASK 1: Script de Verifica√ß√£o da Estrutura
**Arquivo:** `scripts/testing/verificar-estrutura-contas-pagar.js`
**Objetivo:** Verificar estrutura real da tabela no banco

**Funcionalidades:**
- Listar todos os campos da tabela `contas_pagar`
- Verificar tipos de dados
- Verificar constraints
- Verificar se enum existe
- Buscar 3 registros de exemplo
- Comparar estrutura esperada vs real
- Gerar relat√≥rio de inconsist√™ncias

### TASK 2: Criar Service API
**Arquivo:** `src/lib/contas-pagar-api.ts`
**Objetivo:** Centralizar todas as opera√ß√µes de banco

**Fun√ß√µes a implementar:**
```typescript
// Buscar contas com filtros
export async function getContasPagar(
  companyId: string,
  filters?: {
    status?: StatusContaPagar | 'Todas'
    searchTerm?: string
    dataInicio?: string
    dataFim?: string
  }
): Promise<ContaPagar[]>

// Buscar uma conta espec√≠fica
export async function getContaPagarById(id: string): Promise<ContaPagar | null>

// Criar nova conta
export async function createContaPagar(
  data: ContaPagarFormData,
  companyId: string,
  userId: string
): Promise<ContaPagar>

// Atualizar conta
export async function updateContaPagar(
  id: string,
  data: Partial<ContaPagarFormData>,
  userId: string
): Promise<ContaPagar>

// Deletar conta
export async function deleteContaPagar(id: string): Promise<void>

// Buscar estat√≠sticas
export async function getEstatisticas(
  companyId: string
): Promise<ContaPagarEstatisticas>
```

### TASK 3: Atualizar ContasPagarList
**Arquivo:** `src/pages/contas-pagar/ContasPagarList.tsx`
**Mudan√ßas:**
1. Remover import de mocks
2. Adicionar import de API e company-utils
3. Adicionar state para `companyId`
4. Implementar `carregarContas()` real:
   ```typescript
   const carregarContas = async () => {
     try {
       setLoading(true)
       
       // Obter company_id
       if (!companyId) {
         const id = await getOrCreateDefaultCompany()
         setCompanyId(id)
         return // useEffect vai chamar novamente
       }
       
       // Buscar contas reais
       const contasData = await getContasPagar(companyId, {
         status: filtroStatus === 'Todas' ? undefined : filtroStatus,
         searchTerm: searchTerm || undefined
       })
       
       setContas(contasData)
       calcularEstatisticas(contasData)
     } catch (error) {
       console.error('Erro ao carregar contas:', error)
       toast.error('Erro ao carregar contas a pagar')
     } finally {
       setLoading(false)
     }
   }
   ```
5. Atualizar c√°lculo de estat√≠sticas para usar dados reais
6. Melhorar tratamento de erros

### TASK 4: Atualizar ContaPagarForm
**Arquivo:** `src/pages/contas-pagar/ContaPagarForm.tsx`
**Mudan√ßas:**
1. Adicionar import de API e company-utils
2. Adicionar state para `companyId` e `userId`
3. Implementar `loadCompanyId()`:
   ```typescript
   useEffect(() => {
     loadCompanyId()
   }, [])
   
   const loadCompanyId = async () => {
     const { data: { user } } = await supabase.auth.getUser()
     if (user) setUserId(user.id)
     
     const id = await getOrCreateDefaultCompany()
     setCompanyId(id)
   }
   ```
4. Atualizar `handleSubmit()`:
   ```typescript
   // Remover l√≥gica direta do Supabase
   // Usar: await createContaPagar(contaData, companyId, userId)
   // ou: await updateContaPagar(id, contaData, userId)
   ```
5. Garantir que `company_id`, `created_by`, `updated_by` sejam preenchidos

### TASK 5: Verificar e Ajustar Status
**Objetivo:** Alinhar valores de status entre banco e c√≥digo

**A√ß√µes:**
1. Verificar se enum `status_conta_pagar` existe no banco
2. Se usar enum, ajustar c√≥digo para converter:
   - 'Pendente' ‚Üî 'pendente'
   - 'Paga' ‚Üî 'pago'
   - 'Atrasada' ‚Üî 'atrasado'
   - 'Cancelada' ‚Üî 'cancelado'
3. Criar fun√ß√£o de mapeamento se necess√°rio
4. Atualizar trigger do banco se necess√°rio

### TASK 6: Atualizar Tipos (se necess√°rio)
**Arquivo:** `src/types/contas-pagar.ts`
**A√ß√µes:**
1. Verificar se tipos est√£o alinhados com estrutura real
2. Adicionar campos faltantes (company_id, obra_id, etc.)
3. Atualizar ContaPagarFormData se necess√°rio

### TASK 7: Melhorar Tratamento de Erros
**Objetivo:** Adicionar mensagens de erro mais descritivas

**Implementar:**
- Try-catch em todas as chamadas de API
- Mensagens de erro espec√≠ficas por tipo
- Logs de debug para desenvolvimento
- Feedback visual para o usu√°rio

### TASK 8: Testes de Integra√ß√£o
**Objetivo:** Validar todas as funcionalidades

**Checklist:**
- [ ] Criar conta nova
- [ ] Listar contas
- [ ] Filtrar por status
- [ ] Buscar por texto
- [ ] Ver detalhes
- [ ] Editar conta
- [ ] Excluir conta
- [ ] Upload de anexo
- [ ] Estat√≠sticas corretas
- [ ] Company_id sendo preenchido
- [ ] RLS funcionando (usu√°rio s√≥ v√™ suas contas)

---

## üö® Pontos de Aten√ß√£o

### 1. Company ID
- ‚úÖ Fun√ß√£o `getOrCreateDefaultCompany()` j√° existe
- ‚úÖ Usada com sucesso em outras p√°ginas
- ‚ö†Ô∏è Garantir que seja chamada antes de qualquer opera√ß√£o

### 2. Status Values
- ‚ö†Ô∏è Banco pode usar enum em min√∫sculas
- ‚ö†Ô∏è C√≥digo TypeScript usa primeira letra mai√∫scula
- ‚ö†Ô∏è Precisamos mapear entre os dois formatos

### 3. Campos Obrigat√≥rios
- ‚ö†Ô∏è Migration oficial (11_contas_pagar.sql) usa campos em ingl√™s
- ‚ö†Ô∏è C√≥digo TypeScript espera campos em portugu√™s
- ‚ö†Ô∏è Verificar qual estrutura est√° realmente no banco

### 4. RLS (Row Level Security)
- ‚úÖ Pol√≠ticas j√° est√£o configuradas na migration
- ‚ö†Ô∏è Garantir que `get_user_company_id()` funcione corretamente
- ‚ö†Ô∏è Testar se usu√°rio s√≥ v√™ contas da pr√≥pria empresa

---

## üìà Ordem de Execu√ß√£o Recomendada

1. **TASK 1** - Verificar estrutura real do banco
2. **TASK 5** - Ajustar status se necess√°rio
3. **TASK 6** - Atualizar tipos se necess√°rio
4. **TASK 2** - Criar service API
5. **TASK 3** - Atualizar listagem
6. **TASK 4** - Atualizar formul√°rio
7. **TASK 7** - Melhorar tratamento de erros
8. **TASK 8** - Executar testes

---

## ‚úÖ Crit√©rios de Sucesso

- [ ] Listagem mostra dados reais do banco
- [ ] Filtros funcionam corretamente
- [ ] Estat√≠sticas s√£o calculadas sobre dados reais
- [ ] Cria√ß√£o de conta funciona com company_id preenchido
- [ ] Edi√ß√£o funciona corretamente
- [ ] Exclus√£o funciona corretamente
- [ ] Upload de anexo funciona
- [ ] RLS funciona (isolamento por empresa)
- [ ] Tratamento de erros est√° robusto
- [ ] N√£o h√° mais nenhum uso de mocks

---

## üìö Refer√™ncias

- `worldpav/src/lib/company-utils.ts` - Fun√ß√£o para obter company_id
- `worldpav/src/pages/obras/ObrasList.tsx` - Exemplo de uso de getOrCreateDefaultCompany
- `worldpav/src/pages/colaboradores/ColaboradoresList.tsx` - Exemplo de integra√ß√£o real
- `worldpav/db/migrations/11_contas_pagar.sql` - Migration oficial
- `worldpav/src/types/contas-pagar.ts` - Tipos TypeScript

---

**Data de Cria√ß√£o:** 2025-01-27  
**√öltima Atualiza√ß√£o:** 2025-01-27  
**Status:** üìù Planejamento


